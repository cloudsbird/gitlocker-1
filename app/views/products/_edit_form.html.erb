<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
<div class="add_product_form">
  <%= form_for @product, url: product_path(@product), method: :patch, data: { turbo: false, remote: true }, html: { id: "product-form" } do |f| %>
    <div class="space-y-12">
      <div class="border-b border-gray-900/10 pb-12">
        <h2 class="text-base font-semibold leading-7 text-gray-900">Product Information</h2>
        <p class="mt-1 text-sm leading-6 text-gray-600">Below are your basic product information.</p>

        <div class="mt-10 grid grid-cols-1 gap-x-6 gap-y-8 sm:grid-cols-6">

          <div class="sm:col-span-4" id= "url-field">
            <%= f.label :url,"GitHub Private Repository URL", class: "block text-sm font-medium leading-6 text-gray-900" %>
            <div class="mt-2">
              <%= f.text_field :url, class: "block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6", maxlength: "70", placeholder: "Paste Repository URL", readonly: true %>
            </div>
          </div>

          <div class="sm:col-span-4">
            <%= f.label :name, class: "block text-sm font-medium leading-6 text-gray-900" %>
            <div class="mt-2">
              <%= f.text_field :name, class: "block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6", maxlength: "70", required: true %>
            </div>
          </div>

          <div class="sm:col-span-4">
            <%= f.label :description, class: "block text-sm font-medium leading-6 text-gray-900" %>
            <div class="mt-2">
              <%= f.text_area :description, id: "descriptionTextArea", class: "block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6", required: true %>
              <span class="d-block question_modal_input_subtext" id="charCountElement">
                1000 words left
              </span>
            </div>
          </div>

          <div class="sm:col-span-4">
            <%= f.label :price, class: "block text-sm font-medium leading-6 text-gray-900" %>
            <div class="mt-2">
              <%= f.number_field :price, class: "block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6", required: true %>
            </div>
          </div>

        <div class="sm:col-span-4">
          <%= f.label :covers, class: "block text-sm font-medium leading-6 text-gray-900" do %>
            Cover Images (Limit of 3 and max file size of 100mb each)
          <% end %>
          <div class="mt-2">
            <% if @product.covers.attached? %>
              <ul>
                <% @product.covers.each do |cover| %>
                  <li>
                    <%= image_tag cover.variant(resize_to_limit: [100, 100]) %>
                  </li>
                <% end %>
              </ul>
            <% end %>
            <%= f.file_field :covers, multiple: true, class: "form-control", id: "covers" %>
          </div>
          <br>
          <h1>(To select multiple images please use CTRL on Windows or command on Mac)</h1>
        </div>

          <div class="sm:col-span-4">
            <label for="product_video_source" class="block text-sm font-medium leading-6 text-gray-900">Video Source</label>
            <div class="mt-2">
              <select id="product_video_source" class="form-control" onchange="toggleVideoFields()">
                <option value="">Select Video Source</option>
                <option value="Preview Video URL">Preview Video URL</option>
                <option value="Preview Video File">Preview Video File</option>
              </select>
            </div>
          </div>

          <div class="sm:col-span-4" id="preview_video_url_field" style="<%= @product.preview_video_url.present? ? '' : 'display: none;' %>">
            <%= f.label :preview_video_url, class: "block text-sm font-medium leading-6 text-gray-900" %>
            <div class="mt-2">
              <%= f.text_field :preview_video_url, value: @product.preview_video_url, class: "form-control", id: "product_preview_video_url" %>
            </div>
          </div>

          <div class="sm:col-span-4" id="video_file_field" style="<%= @product.video_file.attached? ? '' : 'display: none;' %>">
            <%= f.label :video_file, class: "block text-sm font-medium leading-6 text-gray-900" do %>
              Preview Video Source (file size limit of 1 GB)
            <% end %>
            <div class="mt-2">
              <% if @product.video_file.attached? %>
                <video width="400" controls>
                  <source src="<%= url_for(@product.video_file) %>" type="video/mp4">
                  Your browser does not support HTML5 video.
                </video>
              <% end %>
              <%= f.file_field :video_file, class: "form-control", id: "product_video_file" %>
            </div>
          </div>

        <div class="sm:col-span-4">
          <%= f.label :categories, class: "block text-sm font-medium leading-6 text-gray-900" %>
          <div class="mt-2">
            <select class="js-example-basic-multiple w-40 sm:w-50 mt-1 block rounded-md shadow-sm border-gray-300 focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" id="categoriesSelect" multiple="multiple">
              <% Category.all.each do |category| %>
                <option value="<%= category.id %>" <%= 'selected' if @product.categories.include?(category) %>><%= category.name %></option>
              <% end %>
            </select>
          </div>
        </div>

          <div class="sm:col-span-4">
            <%= f.label :language_ids, "Languages", class: "block text-sm font-medium leading-6 text-gray-900" %>
            <div class="mt-2">
              <select class="js-example-basic-multiple w-40 sm:w-50 mt-1 block rounded-md shadow-sm border-gray-300 focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" id="languagesSelect" multiple="multiple">
                <% Language.all.each do |language| %>
                  <option value="<%= language.id %>" <%= 'selected' if @product.language_ids.include?(language.id) %>><%= language.name %></option>
                <% end %>
              </select>
            </div>
          </div>

          <div class="sm:col-span-4">
              <div id="upload-status" class="mt-2"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="mt-6 flex items-center justify-end gap-x-6">
      <%= link_to "Cancel", :back, class: "text-sm font-semibold leading-6 text-gray-900" %>
      <%= f.submit "Save", class: "rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600" %>
    </div>
  <% end %>
</div>
<div class="mssg_saved_successfully flex gap-10 flex-col justify-center items-center" style="display: none">
  <div class="loader_icon">
    <i class="fa fa-spinner fa-spin" style="font-size: 90px; color: rgba(22,101,52,.8)"></i>
  </div>
  <p>We are process your files in the background. You can close this tab also. You will be notified when it is on the market.</p>
</div>
<script type="text/javascript">
  function toggleVideoFields() {
    var selectedOption = $("#product_video_source").val();
    if (selectedOption === "Preview Video URL") {
      $("#preview_video_url_field").show();
      $("#video_file_field").hide();
    } else if (selectedOption === "Preview Video File") {
      $("#preview_video_url_field").hide();
      $("#video_file_field").show();
    } else {
      $("#preview_video_url_field").hide();
      $("#video_file_field").hide();
    }
  }
  $(document).ready(function() {
    toggleVideoFields();
    $("#product_video_source").change(function() {
      toggleVideoFields();
    });
    $('.js-example-basic-multiple').select2();
    var selectedCategories = [];
    var selectedLanguages = [];

   <% @product.categories.each do |category| %>
    selectedCategories.push(<%= category.id %>);
    <% end %>

    <% @product.languages.each do |language| %>
      selectedLanguages.push("<%= language.id %>");
    <% end %>

    $('#categoriesSelect').on('change', function() {
      selectedCategories = $(this).val();
      console.log(selectedCategories);
    });

    $('#languagesSelect').on('change', function() {
      selectedLanguages = $(this).val();
      console.log(selectedLanguages);
    });

    $('#product-form').submit(function(event) {
      event.preventDefault();
      
      var formData = new FormData();
      formData.append('authenticity_token', $('meta[name=csrf-token]').attr('content'));
      formData.append('product[name]', $('#product_name').val());
      formData.append('product[description]', ckEditorInstance.getData());
      formData.append('product[price]', $('#product_price').val());
      formData.append('product[product_url]', $('#product_url').val());
      var coverImages = $('#covers')[0].files;
      $.each(coverImages, function(index, image) {
          formData.append('product[covers][]', image);
      });
      const fileInput = document.getElementById('product_video_file');
      const product_file = fileInput.files[0];

      if (product_file) {
        formData.append('product[video_file]', product_file);
      }
      formData.append('product[preview_video_url]', $('#product_preview_video_url').val());
      
      if (selectedCategories && selectedCategories.length > 0) {
        formData.set('product[category_ids][]', selectedCategories);
      }
      if (selectedLanguages && selectedLanguages.length > 0) {
        formData.set('product[language_ids][]', selectedLanguages);
      }
      var url = "/products/" + <%= @product.id %>;

      $.ajax({
          type: 'PATCH',
          url: url,
          data: formData,
          processData: false,
          contentType: false,
          xhr: function() {
              var xhr = new window.XMLHttpRequest();
              xhr.upload.addEventListener('progress', function(evt) {
                $('#upload-status').html('<img class="w-10 h-10" src="<%= asset_path('loading.gif') %>" alt="Loading"> Uploading');
              }, false);
              return xhr;
          },
          success: function(data) {
              $('#upload-status').html('<img class="w-10 h-10" src="<%= asset_path('tick.png') %>" alt="Tick"> Upload complete');
              $(".add_product_form").hide();
              $(".mssg_saved_successfully").show()
          },
          error: function(xhr, status, error) {
              if (xhr.status === 422) {
                  var errors = xhr.responseJSON.message;
                  if (errors) {
                      $('#upload-status').text('Error: ' + errors);
                  } else {
                      $('#upload-status').text('Error: ' + error);
                  }
              } else {
                  $('#upload-status').text('Error: ' + error);
              }
          }
      });

    });

    var titleInput = document.getElementById('product_name');
    titleInput.addEventListener('input', function() {
      var currentValue = this.value;
      if (currentValue.length > 70) {
        this.value = currentValue.slice(0, 70);
      }
    });

    var ckEditorInstance;
    var interval = setInterval(() => {
      if (typeof CKEDITOR !== 'undefined') {
        try {
          ckEditorInstance = CKEDITOR.replace('descriptionTextArea');
          ckEditorInstance.on('change', function(event) {
            var content = event.editor.getData();
            var plainTextContent = content.replace(/<[^>]*>/g, '').replace(/&nbsp;/g, ' ');
            var wordCount = plainTextContent.trim().split(/\s+/).length;
            var wordsLeft = 1000 - wordCount;
            $('#charCountElement').text(`${wordsLeft} words left`);
            $('#charCountElement').css('color', wordsLeft < 0 ? 'red' : '');
            if (wordsLeft < 0) {
              setTimeout(function() {
                ckEditorInstance.setData(stripHtmlTags(plainTextContent.split(/\s+/).slice(0, 999).join(' ')));
              }, 0);
              alert('Error: Word limit exceeded (maximum 1000 words)');
            }
          });
          clearInterval(interval);
        } catch (e) {
          console.error(e);
        }
      }
    }, 100);

    function stripHtmlTags(html) {
      var div = document.createElement("div");
      div.innerHTML = html;
      var textContent = div.textContent || div.innerText || "";
      return textContent.trim().replace(/&/g, '').replace(/\s+/g, ' ').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    $('#covers').on('change', function() {
      var coverImages = this.files;
      if (coverImages.length > 3) {
          alert("You can select up to 3 cover images.");
          this.value = '';
      }

      let totalSizeInMB = 0;

      for (let i = 0; i < coverImages.length; i++) {
        const file = coverImages[i];
        const fileSizeInMB = file.size / (1024 * 1024); 

        if (fileSizeInMB > 100) {
          alert('One or more cover images exceed the 100 MB size limit. Please select smaller images.');
          this.value = null;
          return; 
        }

        totalSizeInMB += fileSizeInMB;
      }

      if (totalSizeInMB > 300) {
        alert('The total size of cover images exceeds the 100 MB limit. Please select fewer images or smaller ones.');
        this.value = null;
        return;
      }
    });

    const fileInput = document.getElementById('product_video_file');

    fileInput.addEventListener('change', function(event) {
      const product_file = fileInput.files[0];

      if (product_file) {
        const fileSizeInGB = product_file.size / (1024 * 1024 * 1024);
        const fileSizeLimitGB = 1;

        if (fileSizeInGB > fileSizeLimitGB) {
          alert('File size exceeds the limit of 1 GB. Please select a smaller file.');
          fileInput.value = null;
        }
      }
    });

  });
</script>
