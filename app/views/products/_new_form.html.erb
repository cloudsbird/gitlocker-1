<%= form_for @product, url: products_path, data: {turbo: false, remote: true }, html: { id: "product-form" } do |f| %>
  <div class="space-y-12">
    <div class="border-b border-gray-900/10 pb-12">
      <h2 class="text-base font-semibold leading-7 text-gray-900">Product Information</h2>
      <p class="mt-1 text-sm leading-6 text-gray-600">Below are your basic product information.</p>

      <div class="mt-10 grid grid-cols-1 gap-x-6 gap-y-8 sm:grid-cols-6">
        <div class="sm:col-span-4">
          <%= f.label :name, class: "block text-sm font-medium leading-6 text-gray-900" %>
          <div class="mt-2">
            <%= f.text_field :name, class: "block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6", maxlength: "70", required: true %>
          </div>
        </div>

        <div class="sm:col-span-4">
          <%= f.label :description, class: "block text-sm font-medium leading-6 text-gray-900" %>
          <div class="mt-2">
            <%= f.text_area :description, class: "block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6", required: true %>
          </div>
        </div>

        <div class="sm:col-span-4">
          <%= f.label :price, class: "block text-sm font-medium leading-6 text-gray-900" %>
          <div class="mt-2">
            <%= f.number_field :price, class: "block w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6", required: true %>
          </div>
        </div>

        <div class="sm:col-span-4">
          <%= f.label :covers, class: "block text-sm font-medium leading-6 text-gray-900" do %>
            Cover Images
          <% end %>
          <div class="mt-2">
            <%= f.file_field :covers, multiple: true, class: "form-control", id: "covers" %>
          </div>
        </div>

        <div class="sm:col-span-4">
        <%= f.label :preview_video_url, class: "block text-sm font-medium leading-6 text-gray-900" %>
        <div class="mt-2">
          <%= f.text_field :preview_video_url, class: "form-control", id: "product_preview_video_url" %>
        </div>
        </div>

        <div class="sm:col-span-4">
          <%= f.label :video_file, class: "block text-sm font-medium leading-6 text-gray-900" do %>
            Explainer Video File
          <% end %>
          <div class="mt-2">
            <%= f.file_field :video_file, class: "form-control", id: "product_video_file" %>
          </div>
        </div>

        <div class="sm:col-span-4">
          <%= f.label :categories, class: "block text-sm font-medium leading-6 text-gray-900" %>
          <div class="mt-2">
            <%= f.collection_select :categories, Category.all, :id, :name, {}, { class: "block w-full py-2 px-3 border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" } %>
          </div>
        </div>

        <div class="sm:col-span-4">
          <%= f.label :language_id, class: "block text-sm font-medium leading-6 text-gray-900" %>
          <div class="mt-2">
            <%= f.collection_select :language_id, Language.all, :id, :name, {}, { class: "block w-full py-2 px-3 border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" } %>
          </div>
        </div>

        <div class="sm:col-span-4">
          <%= f.label :upload, class: "block text-sm font-medium leading-6 text-gray-900" do %>
            Product Upload
          <% end %>
          <div class="mt-2">
            <input type="file" id="product-folder" name="product[folder]" multiple webkitdirectory class="block w-full py-1.5 px-4 rounded-md border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
          </div>
        </div>

        <div class="sm:col-span-4">
            <div id="upload-status" class="mt-2"></div>
        </div>
      </div>
    </div>
  </div>
  <div class="mt-6 flex items-center justify-end gap-x-6">
    <%= link_to "Cancel", :back, class: "text-sm font-semibold leading-6 text-gray-900" %>
    <%= f.submit "Save", class: "rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600" %>
  </div>
<% end %>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
<script type="text/javascript">
  $(document).ready(function() {
    $('#product-form').submit(function(event) {
      event.preventDefault();
      
      var folderInput = document.getElementById('product-folder');
      var folderFiles = folderInput.files;

      var formData = new FormData();
      formData.append('authenticity_token', $('meta[name=csrf-token]').attr('content'));
      formData.append('product[name]', $('#product_name').val());
      formData.append('product[description]', $('#product_description').val());
      formData.append('product[price]', $('#product_price').val());
      formData.append('product[language_id]', $('#product_language_id').val());
      var coverImages = $('#covers')[0].files;
      $.each(coverImages, function(index, image) {
          formData.append('product[covers][]', image);
      });
      const fileInput = document.getElementById('product_video_file');
      const product_file = fileInput.files[0];

      if (product_file) {
        formData.append('product[video_file]', product_file);
      }
      formData.append('product[preview_video_url]', $('#product_preview_video_url').val());
      $('#product_categories option:selected').each(function() {
        formData.append('product[category_ids][]', $(this).val());
      });


      var zip = new JSZip();
      
      for (var i = 0; i < folderFiles.length; i++) {
        var file = folderFiles[i];
        zip.file(file.webkitRelativePath, file);
      }

      zip.generateAsync({type:"blob"}).then(function(content) {
        formData.append('product[folder]', content, 'folder.zip');
        
        $.ajax({
          type: 'POST',
          url: '/products',
          data: formData,
          processData: false,
          contentType: false,
          xhr: function() {
            var xhr = new window.XMLHttpRequest();
            xhr.upload.addEventListener('progress', function(evt) {
              if (evt.lengthComputable) {
                $('#upload-status').html('<img class="w-10 h-10" src="<%= asset_path('loading.gif') %>" alt="Loading"> Uploading');
              }
            }, false);
            return xhr;
          },
          success: function(data) {
            $('#upload-status').html('<img class="w-10 h-10" src="<%= asset_path('tick.png') %>" alt="Tick"> Upload complete');
            setTimeout(function() {
              var productId = data.product_id; 
              window.location.href = '/products/' + productId;
            }, 5000);
          },
          error: function(xhr, status, error) {
            $('#upload-progress').text('Error: ' + error);
          }
        });
      });
    });
    var titleInput = document.getElementById('product_name');
    titleInput.addEventListener('input', function() {
      var currentValue = this.value;
      if (currentValue.length > 70) {
        this.value = currentValue.slice(0, 70);
      }
    });
  });
</script>
